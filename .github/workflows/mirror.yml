name: Mirror to Public

on:
  push:
    branches: [ main, dev ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  mirror:
    if: ${{ github.repository == 'expolicores/expolicores-app' }}
    runs-on: ubuntu-latest
    concurrency:
      group: mirror-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name  "expolicores-bot"
          git config user.email "bot@users.noreply.github.com"

      - name: Add mirror remote
        run: |
          git remote add mirror https://github.com/expolicores/expolicores-app-public.git
          git remote -v

      - name: Authenticate using PAT and push current branch to mirror
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          git remote set-url mirror https://x-access-token:${MIRROR_TOKEN}@github.com/expolicores/expolicores-app-public.git
          git push --force-with-lease mirror "$BRANCH:$BRANCH"

      - name: Push tags (optional)
        env:
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          git remote set-url mirror https://x-access-token:${MIRROR_TOKEN}@github.com/expolicores/expolicores-app-public.git
          git push mirror --tags
